; ==============================================================================
; Supervisor 配置文件 - Celery Worker 和 Beat
; 
; 安装: sudo cp celery.conf /etc/supervisor/conf.d/
; 重新加载: sudo supervisorctl reread && sudo supervisorctl update
; ==============================================================================

; ------------------------------------------------------------------------------
; Celery Worker 配置
; ------------------------------------------------------------------------------
[program:celery_worker]
; 命令配置 - 根据实际项目路径修改
command=/path/to/project/venv/bin/celery -A backend.celery_scheduler worker --hostname=podcast_worker@%%h --concurrency=4 --loglevel=info --queues=celery,podcast
directory=/path/to/project
user=www-data

; 进程数量（如需多 worker 可增加）
numprocs=1
process_name=%(program_name)s_%(process_num)02d

; 自动启动和重启配置
autostart=true
autorestart=true
startsecs=10
startretries=3

; 停止信号配置
stopsignal=TERM
stopwaitsecs=600
stopasgroup=true
killasgroup=true

; 日志配置
stdout_logfile=/path/to/project/logs/celery_worker_stdout.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/path/to/project/logs/celery_worker_stderr.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10

; 环境变量
environment=
    CELERY_BROKER_URL="redis://localhost:6379/0",
    CELERY_RESULT_BACKEND="redis://localhost:6379/1",
    MONGODB_URI="mongodb://localhost:27017",
    MONGODB_DATABASE="podcast_db"

; 优先级（数字越小越先启动）
priority=998


; ------------------------------------------------------------------------------
; Celery Beat 配置 (定时任务调度器)
; ------------------------------------------------------------------------------
[program:celery_beat]
; 命令配置 - 根据实际项目路径修改
command=/path/to/project/venv/bin/celery -A backend.celery_scheduler beat --loglevel=info --schedule=/path/to/project/run/celerybeat-schedule
directory=/path/to/project
user=www-data

; Beat 只需要单进程
numprocs=1

; 自动启动和重启配置
autostart=true
autorestart=true
startsecs=10
startretries=3

; 停止信号配置
stopsignal=TERM
stopwaitsecs=60
stopasgroup=true
killasgroup=true

; 日志配置
stdout_logfile=/path/to/project/logs/celery_beat_stdout.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile=/path/to/project/logs/celery_beat_stderr.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5

; 环境变量
environment=
    CELERY_BROKER_URL="redis://localhost:6379/0",
    CELERY_RESULT_BACKEND="redis://localhost:6379/1"

; 优先级（Beat 在 Worker 之后启动）
priority=999


; ------------------------------------------------------------------------------
; 进程组配置
; ------------------------------------------------------------------------------
[group:celery]
programs=celery_worker,celery_beat
priority=999
