# 工作记录 - 2026 年 0119

## 背景

对 `deepagents-webapp` 后端做目录分层，减少 `web_app.py` 耦合；同时排查并修复聊天记录保存与查询问题，补齐关键日志，确保线上不再出现“记录查空/查旧”的情况。

## 本次改动范围

- **后端目录分层**：新增 `backend/database`、`backend/services`、`backend/middleware`、`backend/utils` 等目录，并移动相关文件。
- **聊天记录保存日志**：在保存用户消息、AI 回复、聊天记忆时输出成功/失败日志。
- **聊天历史查询修复**：修复历史查询默认返回“最早 N 条”的问题，改为返回“最新 N 条”。
- **时间字段处理**：新增北京时间时间工具函数，保证 `created_at/started_at/ended_at/updated_at` 统一使用东八区北京时间。
- **web_search 工具健壮性**：补齐 `logger` 定义，避免运行时报错。

## 关键问题与结论

### 1) 聊天历史接口返回不是最新数据

- **现象**：接口 `limit=200` 时仍看不到最新对话。
- **原因**：Mongo 查询按 `created_at` 升序并 limit，拿到的是最早的 N 条。
- **修复**：改为 `created_at` 降序取最新 N 条，再反转后返回，保证前端仍是“旧在前新在后”。

### 2) MongoDB 时间显示为 UTC

- **现象**：接口返回 `06:xx`，与本地北京时间 `14:xx` 不一致。
- **修复**：统一用 `get_beijing_time()` 写入时间；`web_app.py` 中上报 tool 的 `started_at/ended_at` 也改为北京时间。

## 变更文件清单

- `backend/database/mongo_manager.py`
- `backend/services/chat_service.py`
- `backend/utils/tools.py`
- `backend/web_app.py`
- `test_imports.py`
- `.gitignore`
- `.env.example`（新增）

## 说明

- `.env` 包含密钥，按规范继续保持在 `.gitignore` 中，不进入仓库。
